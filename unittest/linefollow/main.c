#include <stdint.h>
#include <stdio.h>
#include <string.h>

uint8_t g_data[] =
{
42,45,45,44,33,17,4,2,
42,46,45,45,33,19,7,2,
42,46,45,45,33,19,7,2,
42,46,45,45,33,19,7,2,
42,46,45,45,33,19,7,2,
40,44,46,48,38,26,12,6,
40,44,46,48,38,26,12,6,
40,44,46,48,38,26,12,6,
31,42,46,49,44,34,20,9,
31,42,46,49,44,34,20,9,
31,42,46,49,44,34,20,9,
24,37,43,49,47,41,31,21,
24,37,43,49,47,41,31,21,
24,37,43,49,47,41,31,21,
24,37,43,49,47,41,31,21,
14,33,42,47,47,43,36,27,
14,33,42,47,47,43,36,27,
14,33,42,47,47,43,36,27,
11,30,42,47,47,45,39,32,
11,30,42,47,47,45,39,32,
11,30,42,47,47,45,39,32,
7,25,38,47,48,46,42,39,
7,25,38,47,48,46,42,39,
7,25,38,47,48,46,42,39,
7,25,38,47,48,46,42,39,
7,25,38,47,48,46,42,39,
7,25,38,47,48,46,42,39,
7,25,38,47,48,46,42,39,
0,13,28,38,46,46,46,49,
0,13,28,38,46,46,46,49,
0,13,28,38,46,46,46,49,
0,11,25,37,46,46,47,49,
0,11,25,37,46,46,47,49,
0,11,25,37,46,46,47,49,
0,8,22,35,44,45,47,49,
0,8,22,35,44,45,47,49,
0,8,22,35,44,45,47,49,
0,8,22,35,44,45,47,49,
0,5,18,33,42,45,45,51,
0,5,18,33,42,45,45,51,
0,5,18,33,42,45,45,51,
0,0,14,25,38,42,47,53,
0,0,14,25,38,42,47,53,
0,0,14,25,38,42,47,53,
0,0,5,17,33,40,44,51,
0,0,5,17,33,40,44,51,
0,0,5,17,33,40,44,51,
0,0,5,17,33,40,44,51,
0,0,0,11,24,34,42,50,
0,0,0,11,24,34,42,50,
0,0,0,11,24,34,42,50,
0,0,0,5,20,29,41,50,
0,0,0,5,20,29,41,50,
0,0,0,5,20,29,41,50,
0,0,0,0,13,24,36,46,
0,0,0,0,13,24,36,46,
0,0,0,0,13,24,36,46,
0,0,0,0,13,24,36,46,
0,0,0,0,7,16,30,44,
0,0,0,0,7,16,30,44,
0,0,0,0,7,16,30,44,
0,0,0,0,3,12,27,40,
0,0,0,0,3,12,27,40,
0,0,0,0,3,12,27,40,
0,0,0,0,2,10,25,38,
0,0,0,0,2,10,25,38,
0,0,0,0,2,10,25,38,
0,0,0,0,2,10,25,38,
0,0,0,0,1,7,19,37,
0,0,0,0,1,7,19,37,
0,0,0,0,1,7,19,37,
0,0,0,0,0,2,13,31,
0,0,0,0,0,2,13,31,
0,0,0,0,0,2,13,31,
0,0,0,0,0,0,9,24,
0,0,0,0,0,0,9,24,
0,0,0,0,0,0,9,24,
0,0,0,0,0,0,9,24,
0,0,0,0,0,0,7,24,
0,0,0,0,0,0,7,24,
0,0,0,0,0,0,7,24,
0,0,0,0,0,0,4,20,
0,0,0,0,0,0,4,20,
0,0,0,0,0,0,4,20,
0,0,0,0,0,0,1,14,
0,0,0,0,0,0,1,14,
0,0,0,0,0,0,1,14,
0,0,0,0,0,0,1,14,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,0,4,
0,0,0,0,0,0,0,4,
0,0,0,0,0,0,0,4,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,2,
0,0,0,0,0,0,0,4,
0,0,0,0,0,0,0,4,
0,0,0,0,0,0,0,4,
0,0,0,0,0,0,0,6,
0,0,0,0,0,0,0,6,
0,0,0,0,0,0,0,6,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,0,9,
0,0,0,0,0,0,1,13,
0,0,0,0,0,0,1,13,
0,0,0,0,0,0,1,13,
0,0,0,0,0,0,4,18,
0,0,0,0,0,0,4,18,
0,0,0,0,0,0,4,18,
0,0,0,0,0,0,7,20,
0,0,0,0,0,0,7,20,
0,0,0,0,0,0,7,20,
0,0,0,0,0,0,7,20,
0,0,0,0,0,0,9,27,
0,0,0,0,0,0,9,27,
0,0,0,0,0,0,9,27,
0,0,0,0,0,2,13,32,
0,0,0,0,0,2,13,32,
0,0,0,0,0,2,13,32,
0,0,0,0,0,4,18,33,
0,0,0,0,0,4,18,33,
0,0,0,0,0,4,18,33,
0,0,0,0,0,4,18,33,
0,0,0,0,1,7,22,38,
0,0,0,0,1,7,22,38,
0,0,0,0,1,7,22,38,
0,0,0,0,2,9,27,40,
0,0,0,0,2,9,27,40,
0,0,0,0,2,9,27,40,
0,0,0,0,4,13,30,43,
0,0,0,0,4,13,30,43,
0,0,0,0,4,13,30,43,
0,0,0,0,4,13,30,43,
0,0,0,0,7,17,31,45,
0,0,0,0,7,17,31,45,
0,0,0,0,7,17,31,45,
0,0,0,0,10,19,33,45,
0,0,0,0,10,19,33,45,
0,0,0,0,10,19,33,45,
0,0,0,1,13,24,36,48,
0,0,0,1,13,24,36,48,
0,0,0,1,13,24,36,48,
0,0,0,1,13,24,36,48,
0,0,0,2,17,28,39,48,
0,0,0,2,17,28,39,48,
0,0,0,2,17,28,39,48,
0,0,0,5,18,31,40,49,
0,0,0,5,18,31,40,49,
0,0,0,5,18,31,40,49,
0,0,0,8,22,34,42,49,
0,0,0,8,22,34,42,49,
0,0,0,8,22,34,42,49,
0,0,0,8,22,34,42,49,
0,0,0,11,27,36,43,49,
0,0,0,11,27,36,43,49,
0,0,0,11,27,36,43,49,
0,0,5,16,33,40,44,51,
0,0,5,16,33,40,44,51,
0,0,5,16,33,40,44,51,
0,0,8,17,35,40,45,50,
0,0,8,17,35,40,45,50,
0,0,8,17,35,40,45,50,
0,0,8,17,35,40,45,50,
0,0,8,19,36,42,44,51,
0,0,8,19,36,42,44,51,
0,0,8,19,36,42,44,51,
0,0,14,25,38,43,45,50,
0,0,14,25,38,43,45,50,
0,0,14,25,38,43,45,50,
0,2,16,31,41,44,47,50,
0,2,16,31,41,44,47,50,
0,2,16,31,41,44,47,50,
0,2,16,31,41,44,47,50,
0,7,20,33,44,45,46,49,
0,7,20,33,44,45,46,49,
0,7,20,33,44,45,46,49,
0,11,25,36,46,46,46,48,
0,11,25,36,46,46,46,48,
0,11,25,36,46,46,46,48,
0,13,30,39,48,45,45,45,
0,13,30,39,48,45,45,45,
0,13,30,39,48,45,45,45,
0,13,30,39,48,45,45,45,
1,17,34,43,48,45,44,44,
1,17,34,43,48,45,44,44,
1,17,34,43,48,45,44,44,
4,23,36,46,49,46,42,38,
4,23,36,46,49,46,42,38,
4,23,36,46,49,46,42,38,
8,28,40,48,48,44,40,34,
8,28,40,48,48,44,40,34,
8,28,40,48,48,44,40,34,
8,28,40,48,48,44,40,34,
11,30,42,47,48,45,38,31,
11,30,42,47,48,45,38,31,
11,30,42,47,48,45,38,31,
14,34,42,49,49,44,36,28,
14,34,42,49,49,44,36,28,
14,34,42,49,49,44,36,28,
17,35,44,49,49,44,34,27,
17,35,44,49,49,44,34,27,
17,35,44,49,49,44,34,27,
17,35,44,49,49,44,34,27,
21,37,43,49,46,40,29,20,
46,40,29,20,4,21,37,43
};

#define POINTS (8)

typedef struct
{
    uint8_t data[POINTS];
    uint8_t n;
    float p0;
    float w0;
    float p1;
    float w1;
	uint8_t nLeftEdges;
	float leftEdge;

	uint8_t nRightEdges;
	float rightEdge;
} SLine;


void PrintLine(SLine* pLine)
{
    printf("in{");
    for(int i = 0; i < POINTS; i++)
    {
        printf("%3d ", pLine->data[i]);
    }
    printf("}");

    printf("left[%d]{%f} ", pLine->nLeftEdges, pLine->leftEdge);
    printf("right[%d]{%f} ", pLine->nRightEdges, pLine->rightEdge);
}

// Compute w3 point weighted average around pos
float WeightedAverage(int8_t* derivative, int i, int n)
{
	float a = i > 0 ? derivative[i - 1] : 0;
	float b = derivative[i];
	float c = i < n - 1 ? derivative[i + 1] : 0;

	float sum = a+b+c;
	float w = (a*(i-1) + b*i + c*(i+1))/sum;
	return w;
}


void SearchLeftEdges(SLine* pLine)
{
	// Search for left edges
	int8_t derivative[POINTS + 1];
	for(int i = 0; i < POINTS + 1; i++)
	{
		int8_t diff;
		if(i > 0)
		{
			diff = pLine->data[i] - pLine->data[i - 1];
		}
		else
		{
			diff = pLine->data[i];
		}

		derivative[i] = 0;
		if(diff > 0)
		{
			derivative[i] = diff;
		}
	}

//	printf(" dp:{"); for(int i = 0; i < POINTS + 1; i++) { printf("%3d ", (int)derivative[i]); } printf("} ");

	// Search for positive peaks
	float max = 0;
	int maxpos = 0;
	for(int i = 0; i < 9; i++)
	{
		if(derivative[i] > max)
		{
			max = derivative[i];
			maxpos = i;
		}
	}

	if(max > 10)
	{
		pLine->nLeftEdges = 1;
		pLine->leftEdge = WeightedAverage(derivative, maxpos, POINTS + 1);
	}
}


void SearchRightEdges(SLine* pLine)
{
	// Search for right edges
	int8_t derivative[POINTS + 1];
	for(int i = 0; i < POINTS + 1; i++)
	{
		int8_t diff;
		if(i > 0)
		{
			diff = pLine->data[i] - pLine->data[i - 1];
		}
		else
		{
			diff = pLine->data[i];
		}

		derivative[i] = 0;
		if(diff < 0)
		{
			derivative[i] = -diff;
		}
	}

//	printf(" dp:{"); for(int i = 0; i < POINTS + 1; i++) { printf("%3d ", (int)derivative[i]); } printf("} ");

	// Search for positive peaks
	float max = 0;
	int maxpos = 0;
	for(int i = 0; i < 9; i++)
	{
		if(derivative[i] > max)
		{
			max = derivative[i];
			maxpos = i;
		}
	}

	if(max > 10)
	{
		pLine->nRightEdges = 1;
		pLine->rightEdge = WeightedAverage(derivative, maxpos, POINTS + 1);
	}
}



void AnalyzeLine(SLine* pLine)
{
    pLine->n = 0;
    pLine->p0 = 0.0f;
    pLine->w0 = 0.0f;
    pLine->p1 = 0.0f;
    pLine->w1 = 0.0f;
	pLine->nLeftEdges = 0;
	pLine->leftEdge = 0;

	pLine->nRightEdges = 0;
	pLine->rightEdge = 0;

	// Compute weighted average
    float threshold = 10.0;
    int count = 0;
    float p = 0.0;
    float sum = 0.0;
    for(int i = 0; i < POINTS; i++)
    {
        if(pLine->data[i] > threshold)
        {
            count = 1;
            sum += pLine->data[i];
            p += pLine->data[i]*i;
        }
    }
    
    p = p/sum;
    if(count > 0)
    {
        pLine->p0 = p;
    }
    pLine->n = count;

	SearchLeftEdges(pLine);
	SearchRightEdges(pLine);
}


int main(int argc, char* argv[])
{
    uint32_t nLines = sizeof(g_data)/8;
    for(uint32_t i = 0; i < nLines; i++)
    {
        SLine line;
        memcpy(line.data, g_data + 8*i, 8);
        
        AnalyzeLine(&line);
        PrintLine(&line);
		printf("\n");
    }
    

    return 0;
}
